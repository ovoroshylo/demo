<!doctype html>
<meta charset=utf8>
<meta name="viewport" content="width=device-width, initial-scale=1">

<div>
  <textarea id=editor_json style="display:block;height:150px;width:1000px;"></textarea>
  <button onclick="displayInteractions()">Display</button>
  <div id="test_content" style="margin:15px 0;"></div>
  <div id="exam_content"></div>
</div>
<link rel=stylesheet href="./css/test.css">

<script>

  var lessonsDone = [];

  function lessonMark(e) {
    lessonsDone.push('Lesson ' + (parseInt(e.target.name) + 1));
    displayInteractions();
    displayExams();
  }

  function displayInteractions() {
    const json = JSON.parse(document.getElementById("editor_json").value);
    var tests = json.content.filter(c => c.type === 'document').map(con => con.content).filter(c => c.some(con => con.type === 'test'));
    const doc = document.getElementById("test_content");
    doc.innerHTML = null;
    tests.forEach((test, i) => {
      var disabled = false;
      test.filter(ce => ce.type === 'entryCondition').forEach(cf => {
        cf.attrs.conditions.forEach(ccf => {
          if (ccf.name === 'completed_lessons') {
            disabled = ccf.lessons.some(l => {
              return lessonsDone.indexOf(l) < 0;
            })
          }
        });
      });
      test.filter(c => c.type === 'test').forEach(c => {
        var tt = document.createElement("div");
        doc.appendChild(tt);
        c.content && c.content.forEach(cc => {
          if (cc.type === 'question') {
            var d = document.createElement("div");
            d.innerText = "Question: " + (cc.content && cc.content[0].text);
            tt.appendChild(d);
          }
          if (cc.type === 'answer') {
            var d = document.createElement("div");
            d.style = "margin: 8px 0;";
            tt.appendChild(d);
            var radio = document.createElement("input");
            if (c.attrs.type === 'multi-choice') {
              radio.type = 'checkbox';
            } else {
              radio.name ="name_radio" + i;
              radio.type = 'radio';
            }
            radio.disabled = disabled;
            d.appendChild(radio);
            var lbl = document.createElement("span");
            lbl.innerText = cc.content && cc.content[0].text;
            d.appendChild(lbl);
          }
          if (disabled === true) {
            tt.style = "background: lightgray;"
          } else {
            tt.style = "background: white;"
          }
        });
      });
      var btn = document.createElement("button");
      btn.innerHTML = "Submit";
      btn.name = i;
      btn.onclick = lessonMark;
      btn.style = "margin-bottom: 15px;";
      doc.appendChild(btn);
    });
    displayExams();
  }

  function displayExams() {
    const json = JSON.parse(document.getElementById("editor_json").value);
    var exam = json.content && json.content.filter(c => c.type === 'document').map(con => con.content).filter(c => c.some(con => con.type === 'exam'));
    const ex = document.getElementById("exam_content");
    ex.innerHTML = '';
    var disabled = false;
    exam.forEach((exam, i) => {
      exam.filter(c => c.type === 'entryCondition').forEach(c => {
        c.attrs.conditions.forEach(cc => {
          if (cc.name === 'completed_lessons') {
            disabled = cc.lessons.some(l => {
              return lessonsDone.indexOf(l) < 0;
            })
          }
        });
      });
      exam.filter(c => c.type === 'exam').forEach(c => {
        c.content && c.content.forEach(cc => {
          if (cc.type === 'question') {
            var d = document.createElement("div");
            d.style = "margin-bottom: 10px;";
            d.innerText = "Question: " + (cc.content && cc.content[0].text);
            ex.appendChild(d);
          }
          if (cc.type === 'answer') {
            var d = document.createElement("div");
            ex.appendChild(d);
            var lbl = document.createElement("span");
            lbl.innerText = 'Answer: ';
            d.appendChild(lbl);
            var input = document.createElement("input");
            input.className = "question_input";
            input.disabled = disabled;
            if (disabled === true) {
              input.style = "background: lightgray;"
            } else {
              input.style = "background: white;"
            }
            d.appendChild(input);
          }
        });
      });
      if (disabled === true) {
        ex.style = "background: lightgray;"
      } else {
        ex.style = "background: white;"
      }
    });
  }
</script>
